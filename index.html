<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <title>智能签名系统</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--tg-theme-bg-color, #ffffff);
      color: var(--tg-theme-text-color, #000000);
    }

    .container {
      padding: 20px;
      text-align: center;
    }

    h2 {
      color: var(--tg-theme-text-color, #2c3e50);
    }

    .canvas-container {
      margin-top: 10px;
      background: #fff;
      border: 2px solid var(--tg-theme-hint-color, #e0e0e0);
      border-radius: 12px;
      overflow: hidden;
    }

    canvas {
      width: 100%;
      height: auto;
      touch-action: none;
    }

    .buttons {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 15px;
    }

    button {
      padding: 10px 16px;
      font-size: 16px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 500;
    }

    #clearButton {
      background: #ff6b6b;
      color: white;
    }

    #exportButton {
      background: #4ecdc4;
      color: white;
    }

    #sendButton {
      background: var(--tg-theme-button-color, #6c5ce7);
      color: white;
    }
  </style>
</head>

<body>
  <div class="container">
    <h2>智能签名系统</h2>
    <div class="canvas-container">
      <canvas id="signatureCanvas"></canvas>
    </div>
    <div class="buttons">
      <button id="clearButton">清除</button>
      <button id="exportButton">导出轨迹</button>
      <button id="sendButton">发送轨迹</button>
    </div>
  </div>

  <script>
    const canvas = document.getElementById('signatureCanvas');
    const ctx = canvas.getContext('2d');
    let trajectories = [];
    let drawing = false;
    let currentStroke = [];

    function resizeCanvas() {
      canvas.width = canvas.parentElement.clientWidth;
      canvas.height = canvas.width * 0.625;
    }
    window.addEventListener('resize', resizeCanvas);
    document.addEventListener('DOMContentLoaded', resizeCanvas);

    function getCoords(evt) {
      const rect = canvas.getBoundingClientRect();
      return { x: evt.clientX - rect.left, y: evt.clientY - rect.top };
    }

    function drawStroke(stroke) {
      if (stroke.length === 0) return;
      ctx.beginPath();
      ctx.moveTo(stroke[0].x, stroke[0].y);
      stroke.forEach(p => ctx.lineTo(p.x, p.y));
      ctx.stroke();
    }

    canvas.addEventListener('mousedown', (evt) => {
      drawing = true;
      currentStroke = [];
      currentStroke.push(getCoords(evt));
    });
    canvas.addEventListener('mousemove', (evt) => {
      if (!drawing) return;
      currentStroke.push(getCoords(evt));
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      trajectories.forEach(drawStroke);
      drawStroke(currentStroke);
    });
    canvas.addEventListener('mouseup', () => {
      drawing = false;
      trajectories.push(currentStroke);
    });

    document.getElementById('clearButton').addEventListener('click', () => {
      trajectories = [];
      ctx.clearRect(0, 0, canvas.width, canvas.height);
    });

    document.getElementById('exportButton').addEventListener('click', () => {
      const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(trajectories));
      const anchor = document.createElement('a');
      anchor.setAttribute("href", dataStr);
      anchor.setAttribute("download", "signature.json");
      document.body.appendChild(anchor);
      anchor.click();
      anchor.remove();
    });

    document.getElementById('sendButton').addEventListener('click', () => {
      const data = JSON.stringify({ trajectories });
      if (window.Telegram && Telegram.WebApp) {
        Telegram.WebApp.sendData(data);
      } else {
        alert('Telegram Web App not available!');
      }
    });
  </script>
</body>

</html>
